# Kubernetes Node.js REST API Cluster

Automated Kubernetes cluster deployment on VirtualBox with a Node.js REST API application. This project uses Terraform for infrastructure provisioning and Ansible for cluster configuration.

## ğŸš€ Features

- **Infrastructure as Code**: Terraform provisions VirtualBox VMs
- **Automated Cluster Setup**: Ansible configures Kubernetes cluster
- **Production-Ready API**: Node.js REST API with CRUD operations
- **High Availability**: 3-pod deployment with health checks
- **Single Command Setup**: One script deploys everything

## ğŸ“‹ Prerequisites

- **VirtualBox** (>= 6.0)
- **Terraform** (>= 1.0)
- **Ansible** (>= 2.9)

### Installation

**Ubuntu/Debian:**
```bash
# VirtualBox
sudo apt update
sudo apt install -y virtualbox

# Terraform
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install -y terraform

# Ansible
sudo apt install -y ansible
```

**macOS:**
```bash
brew install virtualbox terraform ansible
```

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            VirtualBox VMs                       â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Master     â”‚      â”‚  Worker 1    â”‚         â”‚
â”‚  â”‚  Node        â”‚â”€â”€â”€â”€â”€â”€â”‚              â”‚         â”‚
â”‚  â”‚              â”‚      â”‚              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                                       â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Worker 2    â”‚         â”‚
â”‚                        â”‚              â”‚         â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                 â”‚
â”‚  Kubernetes Cluster (kubeadm + Flannel)         â”‚
â”‚  Node.js REST API (3 replicas)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Project Structure

```
k8s-node-api-cluster/
â”œâ”€â”€ terraform/                   # Infrastructure provisioning
â”‚   â”œâ”€â”€ main.tf                  # VM resources
â”‚   â”œâ”€â”€ variables.tf             # Configuration variables
â”‚   â”œâ”€â”€ outputs.tf               # Output values
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ inventory.tpl        # Ansible inventory template
â”œâ”€â”€ ansible/                     # Cluster configuration
â”‚   â”œâ”€â”€ ansible.cfg
â”‚   â”œâ”€â”€ playbooks/
â”‚   â”‚   â”œâ”€â”€ prepare-nodes.yml    # Install K8s dependencies
â”‚   â”‚   â”œâ”€â”€ master-init.yml      # Initialize master node
â”‚   â”‚   â”œâ”€â”€ workers-join.yml     # Join workers to cluster
â”‚   â”‚   â”œâ”€â”€ deploy-app.yml       # Deploy Node.js API
â”‚   â”‚   â””â”€â”€ site.yml             # Main playbook
â”‚   â”œâ”€â”€ inventory/               # Generated by Terraform
â”‚   â””â”€â”€ group_vars/              # Ansible variables
â”œâ”€â”€ app/                         # Node.js REST API
â”‚   â”œâ”€â”€ index.js                 # Application code
â”‚   â”œâ”€â”€ package.json             # Dependencies
â”‚   â”œâ”€â”€ Dockerfile               # Container definition
â”‚   â””â”€â”€ deployment.yaml          # Kubernetes manifests
â”œâ”€â”€ setup.sh                     # Main installation script
â”œâ”€â”€ cleanup.sh                   # Cleanup script
â””â”€â”€ README.md                    # This file
```

## ğŸš€ Quick Start

### 1. Clone and Setup

```bash
git clone https://github.com/hrmuwanika/k8s-cluster-virtualbox
cd k8s-node-api-cluster
```

### 2. Configure (Optional)

Edit `terraform/variables.tf` to customize:
- Number of worker nodes (default: 2)
- CPU/Memory allocation
- VM image

### 3. Deploy Everything

Run the automated setup script:

```bash
./setup.sh
```

This will:
1. âœ“ Check prerequisites
2. âœ“ Provision VMs with Terraform (1 master + 2 workers)
3. âœ“ Install Kubernetes with Ansible
4. âœ“ Deploy Node.js REST API
5. âœ“ Display access information

**Estimated time:** 15-20 minutes

## ğŸ”§ Manual Setup

If you prefer step-by-step control:

### Step 1: Provision VMs

```bash
cd terraform
terraform init
terraform plan
terraform apply
```

### Step 2: Setup Kubernetes

```bash
cd ../ansible
ansible-playbook playbooks/site.yml
```

## ğŸŒ Access the Application

After deployment completes, you'll see the master node IP address.

### SSH to Master Node

```bash
ssh vagrant@<master-ip>
```

Default password: `vagrant`

### Check Cluster Status

```bash
ssh vagrant@<master-ip> 'kubectl get nodes'
ssh vagrant@<master-ip> 'kubectl get pods -n node-api'
```

### Access REST API

The API is exposed on NodePort 30080:

```
http://<master-ip>:30080
```

## ğŸ“¡ API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/` | API information |
| GET | `/health` | Health check |
| GET | `/api/items` | Get all items |
| GET | `/api/items/:id` | Get specific item |
| POST | `/api/items` | Create new item |
| PUT | `/api/items/:id` | Update item |
| DELETE | `/api/items/:id` | Delete item |

## ğŸ§ª Testing the API

### Get API Info
```bash
curl http://<master-ip>:30080/
```

### Create Item
```bash
curl -X POST http://<master-ip>:30080/api/items \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Item","description":"My first item"}'
```

### Get All Items
```bash
curl http://<master-ip>:30080/api/items
```

### Update Item
```bash
curl -X PUT http://<master-ip>:30080/api/items/{id} \
  -H "Content-Type: application/json" \
  -d '{"name":"Updated Item"}'
```

### Delete Item
```bash
curl -X DELETE http://<master-ip>:30080/api/items/{id}
```

## ğŸ“Š Monitoring

### Check Pods
```bash
ssh vagrant@<master-ip> 'kubectl get pods -n node-api -o wide'
```

### View Logs
```bash
ssh vagrant@<master-ip> 'kubectl logs -n node-api -l app=node-api --tail=50'
```

### Check Services
```bash
ssh vagrant@<master-ip> 'kubectl get svc -n node-api'
```

## ğŸ”„ Configuration

### Modify VM Resources

Edit `terraform/variables.tf`:

```hcl
variable "worker_count" {
  default = 3  # Change number of workers
}

variable "master_memory" {
  default = "4096 mib"  # Increase master memory
}
```

Then apply changes:
```bash
cd terraform
terraform apply
```

### Modify Application Replicas

Edit `app/deployment.yaml`:

```yaml
spec:
  replicas: 5  # Change from 3 to 5
```

Redeploy:
```bash
cd ansible
ansible-playbook playbooks/deploy-app.yml
```

## ğŸ§¹ Cleanup

To destroy all resources:

```bash
./cleanup.sh
```

Or manually:
```bash
cd terraform
terraform destroy
```

## ğŸ› Troubleshooting

### VMs not starting
- Check VirtualBox is running
- Ensure virtualization is enabled in BIOS
- Check available system resources

### Ansible connection failed
- Wait 30 seconds after VM creation
- Verify VMs are running: `VBoxManage list runningvms`
- Check network configuration

### Pods not ready
```bash
ssh vagrant@<master-ip> 'kubectl describe pod -n node-api'
ssh vagrant@<master-ip> 'kubectl logs -n node-api <pod-name>'
```

### Access denied
- Default username: `vagrant`
- Default password: `vagrant`
- Or use SSH keys generated by Vagrant

## ğŸ“ Notes

- The API uses in-memory storage (data not persisted)
- Each pod response includes hostname for load balancing verification
- Default Kubernetes version: 1.28.0
- Network plugin: Flannel
- Container runtime: containerd

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch
3. Commit your changes
4. Push to the branch
5. Create a Pull Request

## ğŸ“„ License

MIT License - see LICENSE file for details

## ğŸ™ Acknowledgments

- Kubernetes community
- Terraform providers
- Ansible project
- Node.js and Express.js

---

**Happy Clustering! ğŸ‰**

For issues or questions, please open an issue on GitHub.
