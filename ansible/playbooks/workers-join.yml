---
# Join worker nodes to the cluster
- name: Join worker nodes to Kubernetes cluster
  hosts: workers
  gather_facts: yes
  become: yes
  tags: workers

  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Copy join command to worker nodes
      copy:
        src: /tmp/kubeadm-join-command.sh
        dest: /tmp/kubeadm-join-command.sh
        mode: '0755'
      when: not kubelet_conf.stat.exists

    - name: Join worker node to cluster
      command: /tmp/kubeadm-join-command.sh {{ kubeadm_join_extra_opts }}
      when: not kubelet_conf.stat.exists
      register: join_output

    - name: Display join output
      debug:
        var: join_output.stdout_lines
      when: join_output is defined and join_output.stdout_lines is defined

    - name: Wait for node to be ready
      wait_for:
        timeout: 60

- name: Label and configure worker nodes
  hosts: masters
  gather_facts: no
  become: yes
  tags: workers

  tasks:
    - name: Wait for worker nodes to appear
      shell: kubectl get nodes | grep worker | wc -l
      register: worker_count
      until: worker_count.stdout | int == groups['workers'] | length
      retries: 20
      delay: 10
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Label worker nodes
      command: kubectl label node {{ item }} node-role.kubernetes.io/worker=worker --overwrite
      loop: "{{ groups['workers'] }}"
      ignore_errors: yes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Display all nodes
      command: kubectl get nodes -o wide
      register: all_nodes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Show all nodes
      debug:
        var: all_nodes.stdout_lines
