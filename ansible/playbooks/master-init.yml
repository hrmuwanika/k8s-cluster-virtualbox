---
# Initialize Kubernetes master node
- name: Initialize Kubernetes master
  hosts: masters
  gather_facts: yes
  become: yes
  tags: master

  tasks:
    - name: Check if Kubernetes is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeadm_init

    - name: Initialize Kubernetes cluster
      command: >
        kubeadm init
        --pod-network-cidr={{ pod_network_cidr }}
        --service-cidr={{ service_cidr }}
        --apiserver-advertise-address={{ ansible_host }}
        {{ kubeadm_init_extra_opts }}
      when: not kubeadm_init.stat.exists
      register: kubeadm_init_output

    - name: Display kubeadm init output
      debug:
        var: kubeadm_init_output.stdout_lines
      when: kubeadm_init_output is defined and kubeadm_init_output.stdout_lines is defined

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to root's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        owner: root
        group: root
        mode: '0600'

    - name: Create .kube directory for vagrant user
      file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Copy admin.conf to vagrant's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        remote_src: yes
        owner: vagrant
        group: vagrant
        mode: '0600'

    - name: Install Calico CNI
      shell: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/calico.yaml
      when: cni_plugin == "calico"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Install Flannel CNI
      shell: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      when: cni_plugin == "flannel"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Wait for CNI pods to be ready
      shell: kubectl get pods -n kube-system | grep -E 'calico|flannel' | grep -v Running | wc -l
      register: cni_pods_status
      until: cni_pods_status.stdout == "0"
      retries: 30
      delay: 10
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Allow pod scheduling on master (if enabled)
      command: kubectl taint nodes --all node-role.kubernetes.io/control-plane-
      when: master_schedulable is defined and master_schedulable
      ignore_errors: yes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Generate join command
      command: kubeadm token create --print-join-command
      register: join_command
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Save join command to file
      copy:
        content: "{{ join_command.stdout }}"
        dest: /tmp/kubeadm-join-command.sh
        mode: '0755'

    - name: Fetch join command to local machine
      fetch:
        src: /tmp/kubeadm-join-command.sh
        dest: /tmp/kubeadm-join-command.sh
        flat: yes

    - name: Install Helm (if enabled)
      block:
        - name: Download Helm installation script
          get_url:
            url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
            dest: /tmp/get_helm.sh
            mode: '0755'

        - name: Install Helm
          shell: /tmp/get_helm.sh
          args:
            creates: /usr/local/bin/helm

        - name: Verify Helm installation
          command: helm version
          register: helm_version

        - name: Display Helm version
          debug:
            var: helm_version.stdout
      when: install_helm is defined and install_helm
